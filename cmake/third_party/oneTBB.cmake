include (ExternalProject)
include(GNUInstallDirs)

set(ONETBB_INSTALL_DIR ${THIRD_PARTY_DIR}/onetbb)
set(ONETBB_INCLUDE_DIR ${ONETBB_INSTALL_DIR}/include)
set(ONETBB_LIBRARY_DIR ${ONETBB_INSTALL_DIR}/${CMAKE_INSTALL_LIBDIR})

set(ONETBB_URL https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2021.5.0.tar.gz)
use_mirror(VARIABLE ONETBB_URL URL ${ONETBB_URL})

if(CMAKE_BUILD_TYPE STREQUAL "Debug")
  set(tbb_CMAKE_DEBUG_POSTFIX "_debug")
endif()

if(WIN32)
    message(FATAL_ERROR "Windows system does not support onetbb")
else()
    if("${CMAKE_SHARED_LIBRARY_SUFFIX}" STREQUAL ".dylib")
      set(ONETBB_LIBRARY_NAMES libtbb${tbb_CMAKE_DEBUG_POSTFIX}.dylib)
    elseif("${CMAKE_SHARED_LIBRARY_SUFFIX}" STREQUAL ".so")
      set(ONETBB_LIBRARY_NAMES libtbb${tbb_CMAKE_DEBUG_POSTFIX}.so)
      set(TBB_LIBRARY_TYPE ON)
    else()
      message(FATAL_ERROR "${CMAKE_SHARED_LIBRARY_SUFFIX} not support for onetbb")
    endif()

endif()

foreach(LIBRARY_NAME ${ONETBB_LIBRARY_NAMES})
    list(APPEND ONETBB_SHARED_LIBRARIES ${ONETBB_LIBRARY_DIR}/${LIBRARY_NAME})
endforeach()


if(THIRD_PARTY)

ExternalProject_Add(onetbb
    PREFIX onetbb
    URL ${ONETBB_URL}
    URL_MD5 5e5f2ee22a0d19c0abbe7478f1c7ccf6
    UPDATE_COMMAND ""
    BUILD_IN_SOURCE 1
    BUILD_BYPRODUCTS ${ONETBB_SHARED_LIBRARIES}
    CMAKE_CACHE_ARGS
        -DCMAKE_INSTALL_PREFIX:STRING=${ONETBB_INSTALL_DIR}
        -DCMAKE_C_COMPILER_LAUNCHER:STRING=${CMAKE_C_COMPILER_LAUNCHER}
        -DCMAKE_CXX_COMPILER_LAUNCHER:STRING=${CMAKE_CXX_COMPILER_LAUNCHER}
        -DCMAKE_POLICY_DEFAULT_CMP0074:STRING=NEW
        -DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE}
        -DCMAKE_CXX_FLAGS_DEBUG:STRING=${CMAKE_CXX_FLAGS_DEBUG}
        -DCMAKE_CXX_FLAGS_RELEASE:STRING=${CMAKE_CXX_FLAGS_RELEASE}
        -DCMAKE_C_FLAGS_DEBUG:STRING=${CMAKE_C_FLAGS_DEBUG}
        -DCMAKE_C_FLAGS_RELEASE:STRING=${CMAKE_C_FLAGS_RELEASE}
        -DTBB_EXAMPLES:BOOL=OFF
        -DTBB_TEST:BOOL=OFF
        -DBUILD_SHARED_LIBS:BOOL=ON
)

endif(THIRD_PARTY)
add_library(onetbb_imported UNKNOWN IMPORTED)
set_property(TARGET onetbb_imported PROPERTY IMPORTED_LOCATION "${ONETBB_SHARED_LIBRARIES}")
